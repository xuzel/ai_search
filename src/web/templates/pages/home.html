{% extends "base_new.html" %}

{% block title %}AI Search Engine - Home{% endblock %}

{% block content %}
<!-- Hero Section -->
<div style="text-align: center; margin-bottom: var(--space-12);">
  <h1 style="font-size: var(--text-4xl); font-weight: 700; margin-bottom: var(--space-4); color: var(--text-primary);">
    ü§ñ AI Search Engine
  </h1>
  <p style="font-size: var(--text-lg); color: var(--text-secondary); max-width: 600px; margin: 0 auto;">
    Intelligent search powered by LLM. Ask anything, get smart answers.
  </p>
</div>

<!-- Unified Search Box -->
<div class="search-container">
  <form hx-post="/query" hx-target="#results" hx-indicator="#loading" hx-encoding="multipart/form-data" class="search-box">
    <div class="search-input-wrapper">
      <span class="search-icon">üîç</span>
      <input
        type="text"
        name="query"
        class="search-input"
        placeholder="Ask anything... Upload images/documents for analysis"
        autocomplete="off"
        autofocus
      />
      <button type="submit" class="btn btn-primary search-submit">Search</button>
    </div>

    <!-- File Upload Area -->
    <div style="margin-top: var(--space-3);">
      <div class="file-upload-area" id="fileUploadArea">
        <input
          type="file"
          name="file"
          id="fileInput"
          accept=".pdf,.txt,.md,.docx,.png,.jpg,.jpeg,.bmp,.gif"
          style="display: none;"
          onchange="handleFileSelect(event)"
        />
        <label for="fileInput" class="file-upload-label">
          <span style="font-size: 2rem;">üìé</span>
          <p style="margin: var(--space-2) 0 0;">
            <strong>Click to upload</strong> or drag and drop
          </p>
          <p style="font-size: var(--text-sm); color: var(--text-secondary); margin-top: var(--space-1);">
            Images (PNG, JPG) ‚Ä¢ Documents (PDF, TXT, MD, DOCX)
          </p>
        </label>
      </div>

      <!-- File Preview -->
      <div id="filePreview" style="display: none; margin-top: var(--space-3);">
        <div style="display: flex; align-items: center; padding: var(--space-3); background: var(--color-surface); border-radius: var(--radius-md); border: 1px solid var(--color-border);">
          <span id="fileIcon" style="font-size: 1.5rem; margin-right: var(--space-3);">üìÑ</span>
          <div style="flex: 1;">
            <div id="fileName" style="font-weight: 500;"></div>
            <div id="fileSize" style="font-size: var(--text-sm); color: var(--text-secondary);"></div>
          </div>
          <button type="button" onclick="clearFile()" class="btn btn-sm" style="background: none; border: none; font-size: 1.2rem; cursor: pointer;">
            ‚úï
          </button>
        </div>
        <div id="fileHint" style="margin-top: var(--space-2); font-size: var(--text-sm); color: var(--text-secondary); padding: var(--space-2); background: var(--color-surface-secondary); border-radius: var(--radius-sm);">
          <!-- Dynamic hint based on file type -->
        </div>
      </div>
    </div>

    <!-- Type Indicator (shown after classification) -->
    <div id="typeIndicator" class="search-type-indicator" style="display: none;">
      <span>Detected mode:</span>
      <span id="typeBadge" class="search-type-badge"></span>
      <span style="margin-left: auto; font-size: var(--text-xs);">
        <a href="#" onclick="showManualModes(); return false;" style="color: var(--color-primary);">Change mode</a>
      </span>
    </div>
  </form>

  <!-- Loading Indicator -->
  <div id="loading" class="loading-container htmx-indicator">
    <div class="spinner"></div>
    <div class="loading-text">Processing your request...</div>
  </div>
</div>

<!-- Results Container -->
<div id="results"></div>

<!-- Feature Cards -->
<div style="margin-top: var(--space-16);">
  <h2 style="font-size: var(--text-2xl); font-weight: 600; margin-bottom: var(--space-6); text-align: center; color: var(--text-primary);">
    What can I do?
  </h2>

  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: var(--space-6);">
    <!-- Research Mode -->
    <div class="card card-interactive" onclick="document.querySelector('.search-input').focus()">
      <div class="card-header">
        <div style="font-size: var(--text-3xl); margin-bottom: var(--space-3);">üîç</div>
        <h3 class="card-title">Research</h3>
        <p class="card-subtitle">Web search with AI-powered synthesis</p>
      </div>
      <div class="card-body">
        <p style="color: var(--text-secondary); line-height: 1.6;">
          Search the web, scrape content, and get comprehensive AI-generated summaries with source citations.
        </p>
      </div>
      <div class="card-footer">
        <span class="badge badge-primary">Real-time</span>
        <span class="badge badge-secondary">Multi-source</span>
      </div>
    </div>

    <!-- Code Mode -->
    <div class="card card-interactive" onclick="document.querySelector('.search-input').focus()">
      <div class="card-header">
        <div style="font-size: var(--text-3xl); margin-bottom: var(--space-3);">üíª</div>
        <h3 class="card-title">Code</h3>
        <p class="card-subtitle">Generate and execute Python code</p>
      </div>
      <div class="card-body">
        <p style="color: var(--text-secondary); line-height: 1.6;">
          Solve math problems, perform calculations, and run Python code in a secure sandbox environment.
        </p>
      </div>
      <div class="card-footer">
        <span class="badge badge-primary">Safe</span>
        <span class="badge badge-secondary">Python</span>
      </div>
    </div>

    <!-- Document Q&A -->
    <div class="card card-interactive" onclick="window.location.href='/rag'">
      <div class="card-header">
        <div style="font-size: var(--text-3xl); margin-bottom: var(--space-3);">üìö</div>
        <h3 class="card-title">Document Q&A</h3>
        <p class="card-subtitle">Upload documents and ask questions</p>
      </div>
      <div class="card-body">
        <p style="color: var(--text-secondary); line-height: 1.6;">
          Upload PDFs, documents, and get intelligent answers based on your content with source citations.
        </p>
      </div>
      <div class="card-footer">
        <span class="badge badge-success">Available Now</span>
        <span class="badge badge-secondary">RAG</span>
      </div>
    </div>

    <!-- Chat Mode -->
    <div class="card card-interactive" onclick="window.location.href='/chat'">
      <div class="card-header">
        <div style="font-size: var(--text-3xl); margin-bottom: var(--space-3);">üí¨</div>
        <h3 class="card-title">Chat</h3>
        <p class="card-subtitle">Conversational AI assistant</p>
      </div>
      <div class="card-body">
        <p style="color: var(--text-secondary); line-height: 1.6;">
          Have natural conversations, get creative help, and ask general questions.
        </p>
      </div>
      <div class="card-footer">
        <span class="badge badge-secondary">Interactive</span>
        <span class="badge badge-secondary">LLM</span>
      </div>
    </div>

    <!-- Image & OCR -->
    <div class="card card-interactive" onclick="document.querySelector('#fileInput').click()">
      <div class="card-header">
        <div style="font-size: var(--text-3xl); margin-bottom: var(--space-3);">üñºÔ∏è</div>
        <h3 class="card-title">Image & OCR</h3>
        <p class="card-subtitle">Extract text and understand images</p>
      </div>
      <div class="card-body">
        <p style="color: var(--text-secondary); line-height: 1.6;">
          Extract text from images (OCR) or get AI-powered image analysis and descriptions.
        </p>
      </div>
      <div class="card-footer">
        <span class="badge badge-success">Available Now</span>
        <span class="badge badge-secondary">Multimodal</span>
      </div>
    </div>

    <!-- Tools -->
    <div class="card card-interactive" onclick="document.querySelector('.search-input').focus()">
      <div class="card-header">
        <div style="font-size: var(--text-3xl); margin-bottom: var(--space-3);">üõ†Ô∏è</div>
        <h3 class="card-title">Domain Tools</h3>
        <p class="card-subtitle">Weather, stocks, routes & more</p>
      </div>
      <div class="card-body">
        <p style="color: var(--text-secondary); line-height: 1.6;">
          Access specialized tools for weather forecasts, stock prices, route planning, and more.
        </p>
      </div>
      <div class="card-footer">
        <span class="badge badge-success">Available Now</span>
        <span class="badge badge-secondary">API</span>
      </div>
    </div>
  </div>
</div>

<!-- Example Queries -->
<div style="margin-top: var(--space-16); text-align: center;">
  <h3 style="font-size: var(--text-xl); font-weight: 600; margin-bottom: var(--space-4); color: var(--text-secondary);">
    Try these examples
  </h3>
  <div style="display: flex; flex-wrap: wrap; gap: var(--space-3); justify-content: center;">
    <button class="btn btn-outline btn-sm" onclick="fillQuery('What is machine learning?')">
      What is machine learning?
    </button>
    <button class="btn btn-outline btn-sm" onclick="fillQuery('Calculate 25% of 480')">
      Calculate 25% of 480
    </button>
    <button class="btn btn-outline btn-sm" onclick="fillQuery('What\'s the weather in Beijing?')">
      Weather in Beijing
    </button>
    <button class="btn btn-outline btn-sm" onclick="fillQuery('Compare AAPL and TSLA stock prices')">
      Compare stocks
    </button>
    <button class="btn btn-outline btn-sm" onclick="document.querySelector('#fileInput').click()">
      üì∑ Upload image to analyze
    </button>
  </div>
</div>

<style>
.file-upload-area {
  border: 2px dashed var(--color-border);
  border-radius: var(--radius-md);
  padding: var(--space-6);
  text-align: center;
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  background: var(--color-surface);
  position: relative;
  overflow: hidden;
}

.file-upload-area::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(var(--color-primary-rgb, 59, 130, 246), 0.1), transparent);
  transition: left 0.5s;
}

.file-upload-area:hover::before {
  left: 100%;
}

.file-upload-area:hover {
  border-color: var(--color-primary);
  background: var(--color-surface-secondary);
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.file-upload-area.drag-over {
  border-color: var(--color-primary);
  background: var(--color-primary);
  background-opacity: 0.05;
  border-width: 3px;
  transform: scale(1.02);
  box-shadow: 0 8px 24px rgba(var(--color-primary-rgb, 59, 130, 246), 0.2);
}

.file-upload-label {
  cursor: pointer;
  display: block;
  position: relative;
  z-index: 1;
}

.file-upload-label strong {
  color: var(--color-primary);
  transition: all 0.2s;
}

.file-upload-area:hover .file-upload-label strong {
  text-decoration: underline;
}

/* File preview animation */
#filePreview {
  animation: slideIn 0.3s ease-out;
}

@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}
</style>

<script>
// Fill query in search box
function fillQuery(text) {
  const input = document.querySelector('.search-input');
  input.value = text;
  input.focus();
}

// Handle file selection
function handleFileSelect(event) {
  const file = event.target.files[0];
  if (!file) return;

  showFilePreview(file);
}

// Show file preview
function showFilePreview(file) {
  const preview = document.getElementById('filePreview');
  const uploadArea = document.getElementById('fileUploadArea');
  const fileName = document.getElementById('fileName');
  const fileSize = document.getElementById('fileSize');
  const fileIcon = document.getElementById('fileIcon');
  const fileHint = document.getElementById('fileHint');

  // Show preview, hide upload area
  preview.style.display = 'block';
  uploadArea.style.display = 'none';

  // Set file info
  fileName.textContent = file.name;
  fileSize.textContent = formatFileSize(file.size);

  // Set icon and hint based on file type
  const ext = file.name.split('.').pop().toLowerCase();

  if (['png', 'jpg', 'jpeg', 'bmp', 'gif'].includes(ext)) {
    fileIcon.textContent = 'üñºÔ∏è';
    fileHint.innerHTML = `
      <strong>Image uploaded!</strong> You can:
      <br>‚Ä¢ Ask "What's in this image?" for AI analysis
      <br>‚Ä¢ Ask "Extract the text" for OCR
      <br>‚Ä¢ Ask specific questions about the image
    `;
  } else if (['pdf', 'txt', 'md', 'docx'].includes(ext)) {
    fileIcon.textContent = 'üìÑ';
    fileHint.innerHTML = `
      <strong>Document uploaded!</strong>
      <br>‚Ä¢ The document will be added to the knowledge base
      <br>‚Ä¢ You can ask questions about its content
      <br>‚Ä¢ Example: "Summarize this document"
    `;
  }
}

// Clear file
function clearFile() {
  const fileInput = document.getElementById('fileInput');
  const preview = document.getElementById('filePreview');
  const uploadArea = document.getElementById('fileUploadArea');

  fileInput.value = '';
  preview.style.display = 'none';
  uploadArea.style.display = 'block';
}

// Format file size
function formatFileSize(bytes) {
  if (bytes < 1024) return bytes + ' B';
  if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
  return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
}

// Drag and drop support
const uploadArea = document.getElementById('fileUploadArea');

uploadArea.addEventListener('dragover', (e) => {
  e.preventDefault();
  uploadArea.classList.add('drag-over');
});

uploadArea.addEventListener('dragleave', () => {
  uploadArea.classList.remove('drag-over');
});

uploadArea.addEventListener('drop', (e) => {
  e.preventDefault();
  uploadArea.classList.remove('drag-over');

  const files = e.dataTransfer.files;
  if (files.length > 0) {
    document.getElementById('fileInput').files = files;
    showFilePreview(files[0]);
  }
});

// Show manual mode selection
function showManualModes() {
  alert('All modes are now automatically detected! Just ask your question or upload a file.');
}

// Make showToast available globally
function showToast(message, type) {
  if (window.utils && window.utils.showToast) {
    window.utils.showToast(message, type);
  } else {
    console.log(message);
  }
}
</script>
{% endblock %}
