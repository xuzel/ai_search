# é«˜çº§æ¶æ„è®¾è®¡ (High-Level Architecture)

## ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ

```mermaid
flowchart TD
    User["ğŸ‘¤ ç”¨æˆ·æŸ¥è¯¢<br/>User Query"]

    User -->|HTTP Request| WebUI["ğŸŒ Web UI / CLI<br/>query.py<br/>Typer / FastAPI"]

    WebUI -->|Input Query| Router["ğŸ¯ æ™ºèƒ½è·¯ç”±å™¨<br/>HybridRouter<br/>å¿«é€Ÿè¯†åˆ«æ„å›¾"]

    %% è·¯ç”±å†³ç­–æµç¨‹
    Router -->|Step 1: å¿«é€Ÿè·¯ç”±| KR["âš¡ å…³é”®è¯è·¯ç”±å™¨<br/>KeywordRouter<br/>Regex Patterns<br/>~10ms"]

    KR -->|è¿”å›å†³ç­– + ç½®ä¿¡åº¦| Decision{ç½®ä¿¡åº¦æ£€æŸ¥<br/>Confidence<br/>Threshold: 0.7}

    Decision -->|âœ… ç½®ä¿¡åº¦ â‰¥ 0.7<br/>é«˜ç½®ä¿¡åŒ¹é…| Route["âœ… è·¯ç”±å†³ç­–<br/>RoutingDecision<br/>Task Type Selected"]

    Decision -->|âŒ ç½®ä¿¡åº¦ < 0.7<br/>éœ€è¦ç²¾å‡†åˆ†ç±»| LR["ğŸ§  LLM è·¯ç”±å™¨<br/>LLMRouter<br/>LLM Classification<br/>ç²¾ç¡®è¯†åˆ«"]

    LR -->|è¿”å›ç²¾ç¡®å†³ç­–| Route

    %% Agent åˆ†æ”¯ - ç ”ç©¶æ¨¡å¼
    Route -->|RESEARCH<br/>æœç´¢ç±»æŸ¥è¯¢| RA["ğŸ” ç ”ç©¶ Agent<br/>ResearchAgent<br/>research()"]

    RA -->|LLM Call #1<br/>ç”Ÿæˆæœç´¢è®¡åˆ’| LLM_R1["ğŸ§  LLM Manager<br/>Qwen / GPT<br/>ç”Ÿæˆ3-5ä¸ªæœç´¢æŸ¥è¯¢"]

    LLM_R1 -->|æœç´¢æŸ¥è¯¢åˆ—è¡¨| ST["ğŸ” æœç´¢å·¥å…·<br/>SearchTool<br/>SerpAPI<br/>å¹¶è¡ŒæŸ¥è¯¢"]

    ST -->|æœç´¢ç»“æœ| SC["ğŸ•·ï¸ çˆ¬è™«å·¥å…·<br/>ScraperTool<br/>trafilatura<br/>å¹¶è¡ŒæŠ“å–"]

    SC -->|ç½‘é¡µæ­£æ–‡å†…å®¹| LLM_R2["ğŸ§  LLM Manager<br/>ç»¼åˆåˆ†æ<br/>å»é‡ + æ’åº"]

    LLM_R2 -->|ç»¼åˆæŠ¥å‘Š<br/>å«æ¥æº| RA_Output["RA ç»“æœ"]

    %% Agent åˆ†æ”¯ - ä»£ç æ¨¡å¼
    Route -->|CODE<br/>è®¡ç®—/ç¼–ç¨‹| CA["ğŸ’» ä»£ç  Agent<br/>CodeAgent<br/>solve()"]

    CA -->|LLM Call #1<br/>ç”Ÿæˆä»£ç | LLM_C1["ğŸ§  LLM Manager<br/>ç”Ÿæˆ Python ä»£ç "]

    LLM_C1 -->|Python Code| CV["âœ“ ä»£ç éªŒè¯å™¨<br/>CodeValidator<br/>AST è¯­æ³•æ£€æŸ¥"]

    CV -->|é€šè¿‡æ£€æŸ¥| CE["âš™ï¸ ä»£ç æ‰§è¡Œå™¨<br/>CodeExecutor<br/>æ£€æŸ¥å¯¼å…¥ç™½åå•"]

    CE -->|å¯¼å…¥åˆæ³•| CE2["ğŸ³ Docker æ²™ç®±<br/>éš”ç¦»æ‰§è¡Œ<br/>30s è¶…æ—¶é™åˆ¶"]

    CE2 -->|æ‰§è¡Œç»“æœ| LLM_C2["ğŸ§  LLM Manager<br/>è§£é‡Šç»“æœ"]

    LLM_C2 -->|ä»£ç  + è¾“å‡º + è§£é‡Š| CA_Output["CA ç»“æœ"]

    %% Agent åˆ†æ”¯ - RAG æ¨¡å¼
    Route -->|RAG<br/>æ–‡æ¡£é—®ç­”| RAGA["ğŸ“– RAG Agent<br/>RAGAgent<br/>query_rag()"]

    RAGA -->|ç”¨æˆ·é—®é¢˜| VS["ğŸ“¦ å‘é‡å­˜å‚¨<br/>VectorStore<br/>ChromaDB<br/>ç›¸ä¼¼åº¦æ£€ç´¢<br/>Top-10"]

    VS -->|ç›¸å…³æ–‡æ¡£æ®µè½| RR["â­ é‡æ’åºå™¨<br/>Reranker<br/>BGE Model<br/>ç²¾æ’ Top-5"]

    RR -->|æœ€ç›¸å…³æ®µè½| LLM_RAG["ğŸ§  LLM Manager<br/>åŸºäºä¸Šä¸‹æ–‡<br/>ç”Ÿæˆç­”æ¡ˆ"]

    LLM_RAG -->|ç²¾å‡†ç­”æ¡ˆ| RAG_Output["RAG ç»“æœ"]

    %% Agent åˆ†æ”¯ - å¯¹è¯æ¨¡å¼
    Route -->|CHAT<br/>æ™®é€šå¯¹è¯| CHA["ğŸ’¬ å¯¹è¯ Agent<br/>ChatAgent<br/>chat()"]

    CHA -->|LLM Call<br/>ç›´æ¥å›å¤| LLM_CHAT["ğŸ§  LLM Manager<br/>ç”Ÿæˆå¯¹è¯"]

    LLM_CHAT -->|å¯¹è¯å†…å®¹<br/>æ”¯æŒæµå¼| CHAT_Output["Chat ç»“æœ"]

    %% é¢†åŸŸå·¥å…· - å¤©æ°”
    Route -->|DOMAIN_WEATHER<br/>å¤©æ°”æŸ¥è¯¢| WEATHER["ğŸŒ¡ï¸ å¤©æ°”å·¥å…·<br/>WeatherTool<br/>OpenWeatherMap API"]

    WEATHER -->|å¤©æ°”æ•°æ®<br/>æ¸©åº¦/æ¹¿åº¦ç­‰| WEATHER_Output["Weather ç»“æœ"]

    %% é¢†åŸŸå·¥å…· - é‡‘è
    Route -->|DOMAIN_FINANCE<br/>è‚¡ç¥¨æŸ¥è¯¢| FINANCE["ğŸ“ˆ é‡‘èå·¥å…·<br/>FinanceTool<br/>Alpha Vantage<br/>+ yfinance Fallback"]

    FINANCE -->|è‚¡ç¥¨æ•°æ®<br/>ä»·æ ¼/æ¶¨è·Œ| FINANCE_Output["Finance ç»“æœ"]

    %% é¢†åŸŸå·¥å…· - è·¯çº¿
    Route -->|DOMAIN_ROUTING<br/>è·¯çº¿è§„åˆ’| ROUTING["ğŸ—ºï¸ è·¯çº¿å·¥å…·<br/>RoutingTool<br/>OpenRouteService"]

    ROUTING -->|è·¯çº¿æ•°æ®<br/>è·ç¦»/æ—¶é—´| ROUTING_Output["Routing ç»“æœ"]

    %% å¤šæ¨¡æ€ - å¯é€‰
    Route -->|MULTIMODAL<br/>å›¾ç‰‡åˆ†æ| MULTI["ğŸ–¼ï¸ å¤šæ¨¡æ€å·¥å…·<br/>OCRTool + VisionTool<br/>PaddleOCR<br/>Gemini Vision"]

    MULTI -->|æ–‡å­— + æè¿°| MULTI_Output["Multimodal ç»“æœ"]

    %% ç»“æœæ±‡èš
    RA_Output --> Agg["ğŸ“Š ç»“æœèšåˆ<br/>Result Aggregation"]
    CA_Output --> Agg
    RAG_Output --> Agg
    CHAT_Output --> Agg
    WEATHER_Output --> Agg
    FINANCE_Output --> Agg
    ROUTING_Output --> Agg
    MULTI_Output --> Agg

    %% ä¿å­˜åˆ°æ•°æ®åº“
    Agg -->|æ ¼å¼åŒ–ç»“æœ| DB["ğŸ’¾ æ•°æ®åº“<br/>SQLite + aiosqlite<br/>ä¿å­˜å¯¹è¯å†å²<br/>conversation_history"]

    %% è¿”å›ç”¨æˆ·
    DB -->|å‡†å¤‡å“åº”| Output["ğŸ“¤ è¾“å‡ºå“åº”<br/>SSE / HTML<br/>è¿”å›ç»™ç”¨æˆ·"]

    Output --> User

    %% å¯é€‰ï¼šå¤æ‚ä»»åŠ¡çš„å·¥ä½œæµå¼•æ“
    User -.->|ğŸ”€ å¤æ‚å¤šæ­¥ä»»åŠ¡| WF["ğŸ”€ å·¥ä½œæµå¼•æ“<br/>WorkflowEngine<br/>ä»»åŠ¡åˆ†è§£ + DAG"]
    WF -->|Decompose into<br/>Subtasks| Router

    %% æ ·å¼å®šä¹‰ - ä½¿ç”¨æä¾›çš„é…è‰²æ–¹æ¡ˆ
    %% æœ€æ·±è‰² #1B2631 - Router, LLM, Database
    style Router fill:#1B2631,stroke:#0F1419,color:#FFFFFF,stroke-width:3px
    style LLM_R1 fill:#1B2631,stroke:#0F1419,color:#FFFFFF,stroke-width:2px
    style LLM_R2 fill:#1B2631,stroke:#0F1419,color:#FFFFFF,stroke-width:2px
    style LLM_C1 fill:#1B2631,stroke:#0F1419,color:#FFFFFF,stroke-width:2px
    style LLM_C2 fill:#1B2631,stroke:#0F1419,color:#FFFFFF,stroke-width:2px
    style LLM_RAG fill:#1B2631,stroke:#0F1419,color:#FFFFFF,stroke-width:2px
    style LLM_CHAT fill:#1B2631,stroke:#0F1419,color:#FFFFFF,stroke-width:2px
    style DB fill:#1B2631,stroke:#0F1419,color:#FFFFFF,stroke-width:3px

    %% æ·±è‰² #2C3E50 - æ ¸å¿ƒ Agent
    style RA fill:#2C3E50,stroke:#1B2631,color:#FFFFFF,stroke-width:2px
    style CA fill:#2C3E50,stroke:#1B2631,color:#FFFFFF,stroke-width:2px
    style RAGA fill:#2C3E50,stroke:#1B2631,color:#FFFFFF,stroke-width:2px
    style CHA fill:#2C3E50,stroke:#1B2631,color:#FFFFFF,stroke-width:2px

    %% ä¸­æ·±è‰² #34495E - å·¥å…·å±‚
    style ST fill:#34495E,stroke:#2C3E50,color:#FFFFFF,stroke-width:2px
    style SC fill:#34495E,stroke:#2C3E50,color:#FFFFFF,stroke-width:2px
    style CV fill:#34495E,stroke:#2C3E50,color:#FFFFFF,stroke-width:2px
    style CE fill:#34495E,stroke:#2C3E50,color:#FFFFFF,stroke-width:2px
    style CE2 fill:#34495E,stroke:#2C3E50,color:#FFFFFF,stroke-width:2px
    style VS fill:#34495E,stroke:#2C3E50,color:#FFFFFF,stroke-width:2px
    style RR fill:#34495E,stroke:#2C3E50,color:#FFFFFF,stroke-width:2px

    %% ä¸­è‰² #5D6D7E - è·¯ç”±å†³ç­–èŠ‚ç‚¹
    style KR fill:#5D6D7E,stroke:#34495E,color:#FFFFFF,stroke-width:2px
    style LR fill:#5D6D7E,stroke:#34495E,color:#FFFFFF,stroke-width:2px
    style Decision fill:#5D6D7E,stroke:#34495E,color:#FFFFFF,stroke-width:2px

    %% æµ…è‰² #AEB6BF - Web UI å±‚
    style WebUI fill:#AEB6BF,stroke:#85929E,color:#1B2631,stroke-width:2px

    %% æ›´æµ…è‰² #D5DBDB - ä¸­é—´æµç¨‹
    style Route fill:#D5DBDB,stroke:#AEB6BF,color:#1B2631,stroke-width:2px
    style Agg fill:#D5DBDB,stroke:#AEB6BF,color:#1B2631,stroke-width:2px
    style RA_Output fill:#D5DBDB,stroke:#AEB6BF,color:#1B2631
    style CA_Output fill:#D5DBDB,stroke:#AEB6BF,color:#1B2631
    style RAG_Output fill:#D5DBDB,stroke:#AEB6BF,color:#1B2631
    style CHAT_Output fill:#D5DBDB,stroke:#AEB6BF,color:#1B2631
    style WEATHER_Output fill:#D5DBDB,stroke:#AEB6BF,color:#1B2631
    style FINANCE_Output fill:#D5DBDB,stroke:#AEB6BF,color:#1B2631
    style ROUTING_Output fill:#D5DBDB,stroke:#AEB6BF,color:#1B2631
    style MULTI_Output fill:#D5DBDB,stroke:#AEB6BF,color:#1B2631

    %% æœ€æµ…è‰² #EBF5FB - ç”¨æˆ·è¾“å…¥è¾“å‡º
    style User fill:#EBF5FB,stroke:#D5DBDB,color:#1B2631,stroke-width:3px
    style Output fill:#EBF5FB,stroke:#D5DBDB,color:#1B2631,stroke-width:3px

    %% é¢†åŸŸå·¥å…· - ä½¿ç”¨ä¸­ç­‰é¢œè‰²
    style WEATHER fill:#5D6D7E,stroke:#34495E,color:#FFFFFF,stroke-width:2px
    style FINANCE fill:#5D6D7E,stroke:#34495E,color:#FFFFFF,stroke-width:2px
    style ROUTING fill:#5D6D7E,stroke:#34495E,color:#FFFFFF,stroke-width:2px
    style MULTI fill:#5D6D7E,stroke:#34495E,color:#FFFFFF,stroke-width:2px

    %% å¯é€‰å·¥ä½œæµå¼•æ“
    style WF fill:#85929E,stroke:#5D6D7E,color:#FFFFFF,stroke-width:2px
```

---

## æ¶æ„å±‚æ¬¡è¯´æ˜

### 1ï¸âƒ£ è¾“å…¥å±‚ (Input Layer)
- **Web UI / CLI** - ç”¨æˆ·äº¤äº’å…¥å£
  - FastAPI å¼‚æ­¥ Web åº”ç”¨
  - Typer å‘½ä»¤è¡Œæ¡†æ¶
  - å¤„ç† HTTP è¯·æ±‚

### 2ï¸âƒ£ è·¯ç”±å±‚ (Routing Layer)
æ™ºèƒ½æŸ¥è¯¢åˆ†ç±»ï¼Œæ˜¯ç³»ç»Ÿçš„å…³é”®å†³ç­–éƒ¨åˆ†ã€‚

**HybridRouter ä¸‰å±‚ç­–ç•¥**ï¼š
```
Input Query
    â†“
Step 1: KeywordRouter (å¿«é€Ÿ, ~10ms)
    â”œâ”€ å…³é”®è¯åŒ¹é…
    â”œâ”€ Regex æ¨¡å¼è¯†åˆ«
    â””â”€ è¿”å› RoutingDecision + ç½®ä¿¡åº¦
    â†“
Step 2: ç½®ä¿¡åº¦æ£€æŸ¥
    â”œâ”€ ç½®ä¿¡åº¦ â‰¥ 0.7 â†’ è¿”å›ç»“æœ âœ…
    â””â”€ ç½®ä¿¡åº¦ < 0.7 â†’ ç»§ç»­ Step 3
    â†“
Step 3: LLMRouter (ç²¾ç¡®, ~200-500ms)
    â”œâ”€ è°ƒç”¨ LLM åˆ†æ
    â””â”€ è¿”å›ç²¾ç¡® RoutingDecision
```

**ä»»åŠ¡ç±»å‹ä¼˜å…ˆçº§**ï¼ˆä»é«˜åˆ°ä½ï¼‰ï¼š
1. **DOMAIN_WEATHER** - å¤©æ°”å…³é”®è¯
2. **DOMAIN_FINANCE** - è‚¡ç¥¨/é‡‘èå…³é”®è¯
3. **DOMAIN_ROUTING** - è·¯çº¿/å¯¼èˆªå…³é”®è¯
4. **RAG** - æ–‡æ¡£é—®ç­”å…³é”®è¯
5. **CODE** - è®¡ç®—/ç¼–ç¨‹å…³é”®è¯
6. **RESEARCH** - æœç´¢/ç ”ç©¶å…³é”®è¯
7. **CHAT** - é»˜è®¤ï¼ˆä»»ä½•å…¶ä»–æŸ¥è¯¢ï¼‰
8. **MULTIMODAL** - å›¾ç‰‡åˆ†æï¼ˆå¯é€‰ï¼‰

### 3ï¸âƒ£ Agent å±‚ (Agent Execution Layer)

#### ğŸ” ResearchAgent (ç ”ç©¶ä»£ç†)
```
Input: "2024å¹´AIæœ€æ–°è¿›å±•"

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 1: LLM ç”Ÿæˆæœç´¢è®¡åˆ’            â”‚
â”‚ â†’ 3-5 ä¸ªå…·ä½“æœç´¢æŸ¥è¯¢                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Step 2: å¹¶è¡Œæ‰§è¡Œæœç´¢                â”‚
â”‚ SearchTool (SerpAPI)                â”‚
â”‚ â†’ è·å–æœç´¢ç»“æœé“¾æ¥                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Step 3: å¹¶è¡ŒæŠ“å–å†…å®¹                â”‚
â”‚ ScraperTool (trafilatura)           â”‚
â”‚ â†’ æå–æ¯ä¸ªé“¾æ¥çš„æ­£æ–‡å†…å®¹            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Step 4: LLM ç»¼åˆåˆ†æ                â”‚
â”‚ â†’ å»é‡ã€æ’åºã€ç”Ÿæˆæ€»ç»“              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Output: ç»“æ„åŒ–æŠ¥å‘Š + æ¥æºåˆ—è¡¨
```

#### ğŸ’» CodeAgent (ä»£ç ä»£ç†)
```
Input: "è®¡ç®—1-100çš„è´¨æ•°"

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 1: LLM ç”Ÿæˆ Python ä»£ç        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Step 2: ä»£ç éªŒè¯                    â”‚
â”‚ CodeValidator (AST æ£€æŸ¥)            â”‚
â”‚ âœ“ è¯­æ³•åˆæ³•                          â”‚
â”‚ âœ“ å¯¼å…¥åœ¨ç™½åå•ä¸­                    â”‚
â”‚ âœ“ æ— å±é™©æ¨¡å¼                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Step 3: æ²™ç®±æ‰§è¡Œ                    â”‚
â”‚ CodeExecutor (Docker éš”ç¦»)          â”‚
â”‚ â€¢ ç‹¬ç«‹å®¹å™¨è¿è¡Œ                      â”‚
â”‚ â€¢ 30ç§’è¶…æ—¶é™åˆ¶                      â”‚
â”‚ â€¢ å†…å­˜/CPU é™åˆ¶                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Step 4: ç»“æœè§£é‡Š                    â”‚
â”‚ LLM è§£é‡Šä»£ç å’Œè¾“å‡º                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Output: ä»£ç  + æ‰§è¡Œç»“æœ + è§£é‡Š
```

#### ğŸ“– RAGAgent (æ–‡æ¡£é—®ç­”ä»£ç†)
```
Input: "å¦‚ä½•é…ç½®APIï¼Ÿ"ï¼ˆå·²ä¸Šä¼ æ–‡æ¡£ï¼‰

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 1: å‘é‡æ£€ç´¢                    â”‚
â”‚ VectorStore (ChromaDB)              â”‚
â”‚ â†’ ç›¸ä¼¼åº¦æœç´¢                        â”‚
â”‚ â†’ è¿”å› Top-10 ç›¸å…³ç‰‡æ®µ              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Step 2: æ™ºèƒ½é‡æ’                    â”‚
â”‚ Reranker (BGE Model)                â”‚
â”‚ â†’ ç²¾æ’åº Top-5                      â”‚
â”‚ â†’ å»é™¤å†—ä½™                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Step 3: LLM ç”Ÿæˆç­”æ¡ˆ                â”‚
â”‚ â†’ åŸºäºè¿™5æ®µä¸Šä¸‹æ–‡                   â”‚
â”‚ â†’ ç”Ÿæˆç²¾å‡†å›ç­”                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Output: ç²¾å‡†ç­”æ¡ˆ + ç›¸å…³ç‰‡æ®µå¼•ç”¨
```

#### ğŸ’¬ ChatAgent (å¯¹è¯ä»£ç†)
```
Input: "ä»Šå¤©å¤©æ°”å¦‚ä½•ï¼Ÿ" (æ™®é€šå¯¹è¯)

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç›´æ¥ LLM è°ƒç”¨                       â”‚
â”‚ â†’ ç”Ÿæˆå¯¹è¯å†…å®¹                      â”‚
â”‚ â†’ æ”¯æŒæµå¼å“åº” (SSE)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Output: è‡ªç„¶å¯¹è¯
```

### 4ï¸âƒ£ å·¥å…·å±‚ (Tool Layer)

#### æ ¸å¿ƒå·¥å…·
- **SearchTool** - SerpAPI æœç´¢
- **ScraperTool** - trafilatura å†…å®¹æŠ“å–
- **CodeExecutor** - Docker ä»£ç æ‰§è¡Œ
- **VectorStore** - ChromaDB å‘é‡å­˜å‚¨
- **Reranker** - BGE ç»“æœé‡æ’åº

#### é¢†åŸŸå·¥å…·
- **WeatherTool** - OpenWeatherMap API
- **FinanceTool** - Alpha Vantage + yfinance
- **RoutingTool** - OpenRouteService

#### å¤šæ¨¡æ€å·¥å…·
- **OCRTool** - PaddleOCR æ–‡å­—è¯†åˆ«
- **VisionTool** - Gemini Vision å›¾åƒç†è§£

### 5ï¸âƒ£ LLM å±‚ (LLM Management Layer)

**LLMManager** - ç»Ÿä¸€ LLM æ¥å£

**å¤šæä¾›å•†æ”¯æŒä¸è‡ªåŠ¨ Fallback**ï¼š
```
ä¼˜å…ˆçº§é¡ºåºï¼š

1ï¸âƒ£ Preferred Provider
   â”œâ”€ é€šå¸¸æ˜¯ Aliyun Qwen (æ€§ä»·æ¯”é«˜)
   â””â”€ å¦‚æœå¤±è´¥æˆ–æ— keyï¼Œç»§ç»­

2ï¸âƒ£ Primary Provider
   â”œâ”€ é€šå¸¸æ˜¯ OpenAI GPT (åŠŸèƒ½å…¨)
   â””â”€ å¦‚æœå¤±è´¥æˆ–æ— keyï¼Œç»§ç»­

3ï¸âƒ£ Remaining Providers
   â”œâ”€ DeepSeek
   â”œâ”€ Ollama (æœ¬åœ°)
   â””â”€ å…¶ä»–å…¼å®¹æ¥å£

æœ€ç»ˆï¼šè¿”å›ç¬¬ä¸€ä¸ªå¯ç”¨çš„ Provider çš„ç»“æœ
```

### 6ï¸âƒ£ å­˜å‚¨å±‚ (Storage Layer)

**SQLite + aiosqlite**
- å¼‚æ­¥æ•°æ®åº“æ“ä½œ
- è½»é‡çº§ã€æ— éœ€æœåŠ¡å™¨
- å¿«é€Ÿæœ¬åœ°å­˜å‚¨

**æ•°æ®è¡¨**ï¼š
- `conversation_history` - å¯¹è¯è®°å½•
- `rag_documents` - RAG æ–‡æ¡£å…ƒæ•°æ®
- `vector_store/` - ChromaDB å‘é‡åº“

### 7ï¸âƒ£ è¾“å‡ºå±‚ (Output Layer)

**è¿”å›æ ¼å¼**ï¼š
- **Web UI** - HTML æ¨¡æ¿ + æµå¼ SSE
- **CLI** - å¯Œæ–‡æœ¬æ ¼å¼ (Rich)
- **API** - JSON å“åº”

---

## å…³é”®æµç¨‹ç¤ºä¾‹

### ğŸ” å®Œæ•´æŸ¥è¯¢æµç¨‹ï¼ˆResearch æ¨¡å¼ï¼‰

```
æ—¶é—´è½´ï¼šT0 â†’ T1 â†’ T2 â†’ T3 â†’ T4 â†’ T5

T0: ç”¨æˆ·è¾“å…¥
    "2024 å¹´äººå·¥æ™ºèƒ½æœ€æ–°çªç ´"
    â†“

T1: è·¯ç”±å†³ç­– (~50ms)
    Input â†’ HybridRouter
    â”œâ”€ KeywordRouter: "æœç´¢" å…³é”®è¯åŒ¹é… âœ“
    â”œâ”€ ç½®ä¿¡åº¦: 0.95 (>= 0.7)
    â””â”€ TaskType: RESEARCH âœ…
    â†“

T2: Agent æ‰§è¡Œ (~2-3s)
    ResearchAgent.research()
    â”œâ”€ LLM ç”Ÿæˆ: ["æœ€æ–°AIæ¨¡å‹", "å¤§æ¨¡å‹è¿›å±•", ...]
    â”œâ”€ SearchTool å¹¶è¡ŒæŸ¥è¯¢ (~1s)
    â”œâ”€ ScraperTool å¹¶è¡ŒæŠ“å– (~1s)
    â””â”€ LLM ç»¼åˆåˆ†æ (~0.5s)
    â†“

T3: æ•°æ®åº“ä¿å­˜ (~10ms)
    â†’ conversation_history
    â†“

T4: æ¨¡æ¿æ¸²æŸ“ (~50ms)
    Markdown â†’ HTML
    â†“

T5: SSE è¿”å› (~100ms)
    å®¢æˆ·ç«¯æ”¶åˆ°å®Œæ•´å“åº”
    â†“

æ€»è€—æ—¶: 2.2-3.2 ç§’
```

### ğŸ’» ä»£ç æ‰§è¡Œæµç¨‹ï¼ˆCode æ¨¡å¼ï¼‰

```
T0: ç”¨æˆ·è¾“å…¥
    "è®¡ç®— 1-100 çš„è´¨æ•°"
    â†“

T1: è·¯ç”± (~30ms)
    TaskType: CODE âœ…
    â†“

T2: Agent æ‰§è¡Œ (~1s)
    CodeAgent.solve()
    â”œâ”€ LLM ç”Ÿæˆ Python ä»£ç 
    â”œâ”€ CodeValidator éªŒè¯
    â”‚  â”œâ”€ AST æ£€æŸ¥ âœ“
    â”‚  â”œâ”€ å¯¼å…¥æ£€æŸ¥ âœ“
    â”‚  â””â”€ æ¨¡å¼æ£€æŸ¥ âœ“
    â”œâ”€ CodeExecutor æ‰§è¡Œ
    â”‚  â””â”€ Docker æ²™ç®± (30s è¶…æ—¶)
    â””â”€ LLM è§£é‡Šç»“æœ
    â†“

T3: ä¿å­˜ + è¿”å› (~50ms)
    â†“

æ€»è€—æ—¶: 1-1.5 ç§’
```

### ğŸ“– RAG æŸ¥è¯¢æµç¨‹

```
å‰ç½®å‡†å¤‡ï¼š
  ç”¨æˆ·ä¸Šä¼  PDF â†’ è§£æ â†’ åˆ†å— â†’ å‘é‡åŒ– â†’ å­˜å‚¨

æŸ¥è¯¢æ—¶ï¼š

T0: "æ–‡æ¡£ä¸­å¦‚ä½•é…ç½®APIï¼Ÿ"
    â†“

T1: è·¯ç”± (~30ms)
    TaskType: RAG âœ…
    â†“

T2: Agent æ‰§è¡Œ (~300-500ms)
    RAGAgent.query_rag()
    â”œâ”€ VectorStore.search()
    â”‚  â”œâ”€ å‘é‡ç›¸ä¼¼åº¦è®¡ç®— (~100ms)
    â”‚  â””â”€ è¿”å› Top-10 æ–‡æ®µ
    â”œâ”€ Reranker.rerank()
    â”‚  â”œâ”€ BGE ç²¾æ’ (~100ms)
    â”‚  â””â”€ è¿”å› Top-5 æ–‡æ®µ
    â””â”€ LLM ç”Ÿæˆç­”æ¡ˆ (~100-200ms)
    â†“

T3: ä¿å­˜ + è¿”å› (~50ms)
    â†“

æ€»è€—æ—¶: 0.5-1 ç§’
```

---

## é…è‰²æ–¹æ¡ˆè¯´æ˜

æœ¬æ¶æ„å›¾ä½¿ç”¨æ·±ç°è“åˆ°æµ…è“çš„æ¸å˜è‰²é…è‰²ï¼š

```
æœ€æ·± â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” æœ€æµ…

#1B2631 (æœ€æ·±)
  â”œâ”€ Router æ ¸å¿ƒå†³ç­–
  â”œâ”€ LLM ç®¡ç†å™¨
  â””â”€ æ•°æ®åº“å­˜å‚¨

#2C3E50 (æ·±)
  â””â”€ Agent æ‰§è¡Œå¼•æ“

#34495E (ä¸­æ·±)
  â””â”€ Tool å·¥å…·å±‚

#5D6D7E (ä¸­)
  â”œâ”€ è·¯ç”±æ£€æŸ¥èŠ‚ç‚¹
  â””â”€ é¢†åŸŸå·¥å…·

#AEB6BF (æµ…)
  â””â”€ Web UI è¾“å…¥

#D5DBDB (æ›´æµ…)
  â”œâ”€ ä¸­é—´æµç¨‹
  â””â”€ ç»“æœè¾“å‡º

#EBF5FB (æœ€æµ…)
  â”œâ”€ ç”¨æˆ·è¾“å…¥
  â””â”€ æœ€ç»ˆè¾“å‡º
```

**é…è‰²å¯“æ„**ï¼š
- è¶Šæ·±çš„é¢œè‰² = è¶Šæ ¸å¿ƒçš„ç³»ç»Ÿç»„ä»¶
- è¶Šæµ…çš„é¢œè‰² = è¶Šé è¿‘ç”¨æˆ·çš„äº¤äº’ç•Œé¢
- æ¸…æ™°çš„è‰²é˜¶ä½“ç°äº†ç³»ç»Ÿçš„åˆ†å±‚æ¶æ„

---

## å¯é€‰ï¼šå·¥ä½œæµå¼•æ“ (WorkflowEngine)

å¯¹äº**å¤æ‚å¤šæ­¥ä»»åŠ¡**ï¼Œç³»ç»Ÿå¯é€‰å¯ç”¨ WorkflowEngineï¼š

```
å¤æ‚æŸ¥è¯¢ï¼š
"åˆ†æå°ç±³å…¬å¸ï¼ŒåŒ…æ‹¬è‚¡ä»·ã€æ–°é—»ã€ç«äº‰åˆ†æ"
    â†“

WorkflowEngine åˆ†è§£ï¼š
â”œâ”€ Task 1: æŸ¥è¯¢å°ç±³è‚¡ä»· (é‡‘èå·¥å…·)
â”œâ”€ Task 2: æœç´¢æœ€æ–°æ–°é—» (ç ”ç©¶ä»£ç†)
â””â”€ Task 3: åˆ†æç«äº‰å¯¹æ‰‹ (ç ”ç©¶ä»£ç†)
    â†“

DAG æ‰§è¡Œï¼š
â”œâ”€ Task 1 å’Œ 2 å¹¶è¡Œ (ä¸ä¾èµ–)
â”œâ”€ Task 3 å¯èƒ½ä¾èµ– Task 1/2 çš„ç»“æœ
â””â”€ ç­‰å¾…æ‰€æœ‰ Task å®Œæˆ
    â†“

ResultAggregator èšåˆç»“æœ
    â†“

LLM ç”Ÿæˆç»¼åˆæŠ¥å‘Š
```

---

## æ€§èƒ½æŒ‡æ ‡

| æŸ¥è¯¢ç±»å‹ | è·¯ç”±è€—æ—¶ | æ‰§è¡Œè€—æ—¶ | æ€»è€—æ—¶ | å¤‡æ³¨ |
|---------|---------|---------|--------|------|
| **å¤©æ°”æŸ¥è¯¢** | 30ms | 500ms | 0.5s | API ç›´è°ƒ |
| **è‚¡ç¥¨æŸ¥è¯¢** | 30ms | 300ms | 0.3s | æœ€å¿« |
| **ä»£ç æ‰§è¡Œ** | 30ms | 1000ms | 1.0s | å–å†³äºä»£ç å¤æ‚åº¦ |
| **RAG æŸ¥è¯¢** | 30ms | 500ms | 0.5s | éœ€è¦é¢„å…ˆå‘é‡åŒ– |
| **å¯¹è¯** | 30ms | 1000ms | 1.0s | å–å†³äº LLM å“åº”é€Ÿåº¦ |
| **ç ”ç©¶æ¨¡å¼** | 50ms | 3000ms | 3.0s | æœ€æ…¢ï¼Œæ¶‰åŠç½‘ç»œæŠ“å– |
| **å¤æ‚å·¥ä½œæµ** | 50ms | 5000ms | 5.0s | DAG å¹¶è¡Œä¼˜åŒ– |

> **æ³¨æ„**ï¼šè€—æ—¶æ•°æ®ä¸ºä¼°å€¼ï¼Œå®é™…è€—æ—¶å–å†³äºç½‘ç»œã€LLM æä¾›å•†ã€ç³»ç»Ÿè´Ÿè½½ç­‰å› ç´ 

---

## æ€»ç»“

è¿™ä¸ªæ¶æ„è®¾è®¡éµå¾ªä»¥ä¸‹åŸåˆ™ï¼š

âœ… **åˆ†å±‚æ¸…æ™°** - è¾“å…¥ â†’ è·¯ç”± â†’ Agent â†’ Tool â†’ LLM â†’ å­˜å‚¨ â†’ è¾“å‡º

âœ… **æ™ºèƒ½è·¯ç”±** - å¿«é€Ÿ + ç²¾å‡†çš„åŒè·¯ç”±ç­–ç•¥

âœ… **å¹¶å‘å‹å¥½** - å¼‚æ­¥æ¶æ„ï¼ŒTool å¹¶è¡Œæ‰§è¡Œï¼Œå¤š LLM Provider fallback

âœ… **å®‰å…¨å¯é ** - ä»£ç æ‰§è¡Œä¸‰å±‚é˜²æŠ¤ï¼ŒDocker éš”ç¦»ï¼ŒAPI key ç®¡ç†

âœ… **æ˜“äºæ‰©å±•** - æ¨¡å—åŒ–è®¾è®¡ï¼Œè½»æ¾æ·»åŠ æ–° Agentã€Toolã€Provider

âœ… **ç”¨æˆ·å‹å¥½** - Web UI + CLIï¼Œæ”¯æŒæµå¼å“åº”ï¼Œå®Œæ•´å†å²è®°å½•

---

**æœ€åæ›´æ–°**: 2025-01-09
**é…è‰²æ–¹æ¡ˆ**: ['#1B2631', '#2C3E50', '#34495E', '#5D6D7E', '#85929E', '#AEB6BF', '#D5DBDB', '#EBF5FB']
