{% extends "base.html" %}

{% block title %}History - AI Search Engine{% endblock %}

{% block content %}
<div class="container">
    <div class="result-header">
        <h1>Conversation History</h1>
        <p class="text-muted">View and manage your past conversations</p>
    </div>

    <!-- Statistics -->
    {% if stats %}
    <div class="card mb-3">
        <h3>Statistics</h3>
        <p><strong>Total Conversations:</strong> {{ stats.total }}</p>
        <div style="display: flex; gap: 1rem; margin-top: 0.5rem;">
            {% for mode, count in stats.by_mode.items() %}
            <span>{{ mode }}: {{ count }}</span>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Filters -->
    <div class="history-filters">
        <button class="btn btn-secondary" onclick="filterHistory(null)">All</button>
        <button class="btn btn-secondary" onclick="filterHistory('research')">Research</button>
        <button class="btn btn-secondary" onclick="filterHistory('code')">Code</button>
        <button class="btn btn-secondary" onclick="filterHistory('chat')">Chat</button>
        <button class="btn btn-secondary" style="margin-left: auto;"
                hx-delete="/history"
                hx-confirm="Clear ALL history? This cannot be undone!"
                hx-on::after-request="location.reload()">
            Clear All
        </button>
    </div>

    <!-- Search -->
    <div class="mb-3">
        <form
            hx-get="/history/search"
            hx-target="#history-list"
            hx-trigger="submit"
        >
            <div class="form-group">
                <input
                    type="text"
                    name="q"
                    class="form-input"
                    placeholder="Search conversations..."
                    autocomplete="off"
                >
            </div>
        </form>
    </div>

    <!-- Conversation List -->
    <div id="history-list">
        {% if conversations %}
            {% for conv in conversations %}
            <div
                class="history-item"
                hx-get="/history/{{ conv.id }}"
                hx-target="#conversation-detail"
                hx-swap="innerHTML"
            >
                <div class="history-item-meta">
                    <span style="font-weight: 600; color: var(--accent-warm);">{{ conv.mode }}</span>
                    <span>{{ conv.timestamp[:19] }}</span>
                </div>
                <div class="history-item-query">
                    {{ conv.query[:100] }}{% if conv.query|length > 100 %}...{% endif %}
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="card">
                <p class="text-muted">No conversations found.</p>
            </div>
        {% endif %}
    </div>

    <!-- Conversation Detail -->
    <div id="conversation-detail" class="mt-3"></div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
function filterHistory(mode) {
    const url = mode ? `/history?mode=${mode}` : '/history';
    window.location.href = url;
}
</script>
{% endblock %}
